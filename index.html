<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        
        <title>Peta Rumah Ibadah Surabaya</title>
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />
        
        <!-- Optional local CSS files with error handling -->
        <script>
            function loadCSS(href, fallback) {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = href;
                link.onerror = function() {
                    console.warn(`Failed to load CSS: ${href}`);
                };
                document.head.appendChild(link);
            }
            
            // Load optional CSS files
            const optionalCSS = [
                'css/leaflet.css',
                'css/L.Control.Layers.Tree.css',
                'css/L.Control.Locate.min.css',
                'css/qgis2web.css',
                'css/fontawesome-all.min.css',
                'css/leaflet.photon.css',
                'css/leaflet-measure.css'
            ];
            
            optionalCSS.forEach(css => loadCSS(css));
        </script>

        <style>
            html, body, #map {
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
            
            /* Enhanced Search Card Styles */
            .search-card {
                position: absolute;
                top: 15px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(248, 250, 252, 0.95) 100%);
                padding: 18px;
                border-radius: 16px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.12), 0 4px 12px rgba(0,0,0,0.08);
                width: 90%;
                max-width: 480px;
                display: flex;
                flex-direction: column;
                align-items: center;
                border: 1px solid rgba(255, 255, 255, 0.3);
                transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            .search-card:hover {
                box-shadow: 0 16px 50px rgba(0,0,0,0.15), 0 8px 20px rgba(0,0,0,0.1);
                transform: translateX(-50%) translateY(-3px);
            }
            
            .search-input-container {
                width: 100%;
                position: relative;
            }
            
            #search-input {
                width: 100%;
                padding: 14px 14px 14px 50px;
                border: 2px solid #e2e8f0;
                border-radius: 12px;
                font-size: 16px;
                font-weight: 500;
                box-sizing: border-box;
                background: rgba(255, 255, 255, 0.9);
                background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z" fill="%234a90e2"/></svg>');
                background-repeat: no-repeat;
                background-position: 17px center;
                background-size: 20px;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            
            #search-input:focus {
                outline: none;
                border-color: #4a90e2;
                background-color: rgba(255, 255, 255, 1);
                box-shadow: 0 0 0 4px rgba(74, 144, 226, 0.15), 0 4px 12px rgba(0,0,0,0.08);
            }
            
            #search-input::placeholder {
                color: #94a3b8;
                font-weight: 400;
            }
            
            .card-handle {
                width: 70px;
                height: 5px;
                background: linear-gradient(90deg, #cbd5e1, #94a3b8);
                border-radius: 10px;
                margin-bottom: 14px;
                cursor: grab;
                transition: all 0.3s ease;
                opacity: 0.7;
            }
            
            .card-handle:hover {
                opacity: 1;
                background: linear-gradient(90deg, #94a3b8, #64748b);
            }
            
            .card-handle:active {
                cursor: grabbing;
            }
            
            /* Enhanced Search Results Styles */
            .search-results {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: rgba(255, 255, 255, 0.98);
                border: 2px solid #e2e8f0;
                border-top: none;
                border-radius: 0 0 12px 12px;
                max-height: 280px;
                overflow-y: auto;
                display: none;
                z-index: 10000;
                box-shadow: 0 12px 30px rgba(0,0,0,0.12);
            }
            
            .search-result-item {
                padding: 14px 18px;
                cursor: pointer;
                border-bottom: 1px solid #f1f5f9;
                transition: all 0.3s ease;
                position: relative;
            }
            
            .search-result-item:hover {
                background: linear-gradient(135deg, rgba(74, 144, 226, 0.08) 0%, rgba(99, 179, 237, 0.05) 100%);
                transform: translateX(2px);
            }
            
            .search-result-item:last-child {
                border-bottom: none;
            }
            
            .search-result-item strong {
                color: #1e293b;
                font-weight: 600;
            }
            
            .coordinate-hint {
                font-size: 13px;
                color: #64748b;
                margin-top: 10px;
                text-align: center;
                line-height: 1.5;
                padding: 8px 12px;
                background: rgba(248, 250, 252, 0.8);
                border-radius: 8px;
                border: 1px solid #e2e8f0;
            }
            
            /* Enhanced Loading Indicator */
            .loading {
                display: none;
                position: absolute;
                right: 17px;
                top: 50%;
                transform: translateY(-50%);
                width: 22px;
                height: 22px;
                border: 3px solid #f1f5f9;
                border-top: 3px solid #4a90e2;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            
            @keyframes spin {
                0% { transform: translateY(-50%) rotate(0deg); }
                100% { transform: translateY(-50%) rotate(360deg); }
            }
            
            /* Enhanced Status Messages */
            .status-message {
                position: absolute;
                bottom: 25px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(30, 41, 59, 0.95);
                color: white;
                padding: 12px 20px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 500;
                z-index: 1001;
                display: none;
                box-shadow: 0 8px 25px rgba(0,0,0,0.15);
                transition: all 0.3s ease;
            }
            
            .status-message.success {
                background: linear-gradient(135deg, rgba(34, 197, 94, 0.95) 0%, rgba(22, 163, 74, 0.95) 100%);
            }
            
            .status-message.error {
                background: linear-gradient(135deg, rgba(239, 68, 68, 0.95) 0%, rgba(220, 38, 38, 0.95) 100%);
            }
            
            .status-message.info {
                background: linear-gradient(135deg, rgba(74, 144, 226, 0.95) 0%, rgba(59, 130, 246, 0.95) 100%);
            }
            
            /* Enhanced Popup Styles */
            .leaflet-popup-content {
                margin: 12px 16px;
                line-height: 1.5;
                font-size: 14px;
                max-width: 320px;
            }
            
            .leaflet-popup-content table {
                width: 100%;
                border-collapse: collapse;
                margin: 0;
            }
            
            .leaflet-popup-content th {
                background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                padding: 10px 12px;
                text-align: left;
                font-weight: 600;
                color: #374151;
                border-bottom: 2px solid #e5e7eb;
                font-size: 13px;
            }
            
            .leaflet-popup-content td {
                padding: 10px 12px;
                border-bottom: 1px solid #f3f4f6;
                color: #4b5563;
            }
            
            .leaflet-popup-content td:last-child {
                border-bottom: none;
            }
            
            /* Enhanced Image Display in Popup */
            .popup-image-container {
                text-align: center;
                padding: 8px 0;
                background: #f8fafc;
                border-radius: 8px;
                margin: 4px 0;
                max-width: 90vw;    /* batas maksimal 90% lebar layar */
                max-height: 80vh;   /* batas maksimal 80% tinggi layar */
                overflow: auto;     /* kasih scrollbar kalau terlalu besar */
            }
            
            .popup-image {
                width: auto;        /* biar pakai ukuran asli */
                height: auto;       /* biar pakai ukuran asli */
                max-width: none;    /* jangan dipaksa resize */
                max-height: none;   /* jangan dipaksa resize */
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transition: transform 0.3s ease;
            }
            
            .popup-image:hover {
                transform: scale(1.05);
            }
            
            .image-placeholder {
                display: inline-block;
                padding: 20px;
                background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
                border-radius: 8px;
                color: #64748b;
                font-size: 12px;
                text-align: center;
                border: 2px dashed #cbd5e1;
            }
            
            .image-error-icon {
                font-size: 24px;
                display: block;
                margin-bottom: 8px;
                opacity: 0.6;
            }
            
            /* Responsive Design Improvements */
            @media (max-width: 768px) {
                .search-card {
                    width: 95%;
                    padding: 15px;
                    top: 12px;
                }
                
                #search-input {
                    font-size: 16px; /* Prevents zoom on iOS */
                    padding: 12px 12px 12px 45px;
                }
                
                .coordinate-hint {
                    font-size: 12px;
                }
                
                .leaflet-popup-content {
                    max-width: 280px;
                }
            }
            
            @media (max-width: 480px) {
                .search-card {
                    width: 98%;
                    padding: 12px;
                }
                
                .leaflet-popup-content {
                    max-width: 250px;
                }
                
                .popup-image {
                    max-height: 150px;
                }
            }
            
            /* Map Controls Enhancement */
            .leaflet-control-zoom a {
                font-size: 18px;
                line-height: 32px;
                text-decoration: none;
                color: #374151;
                background: rgba(255, 255, 255, 0.9); 
                transition: all 0.3s ease;
            }
            
            .leaflet-control-zoom a:hover {
                background: rgba(255, 255, 255, 1);
                color: #4a90e2;
            }
            
            .leaflet-control {
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            }
            
            /* Enhanced Error Boundary */
            .error-boundary {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.2);
                text-align: center;
                z-index: 10000;
                display: none;
                max-width: 400px;
                border: 1px solid #e5e7eb;
            }
            
            .error-boundary h3 {
                color: #dc2626;
                margin-bottom: 16px;
            }
            
            .error-boundary button {
                background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                margin-top: 16px;
                transition: all 0.3s ease;
            }
            
            .error-boundary button:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 20px rgba(74, 144, 226, 0.3);
            }
            
            /* Smooth animations for all interactive elements */
            * {
                transition: opacity 0.3s ease, transform 0.3s ease;
            }
            
            /* Custom scrollbar for search results */
            .search-results::-webkit-scrollbar {
                width: 6px;
            }
            
            .search-results::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 3px;
            }
            
            .search-results::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 3px;
            }
            
            .search-results::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        
        <!-- Enhanced Search Interface -->
        <div id="search-card" class="search-card">
            <div class="card-handle" title="Drag to move search card"></div>
            <div class="search-input-container">
                <input id="search-input" type="text" placeholder="🔍 Cari rumah ibadah, lokasi, atau koordinat..." autocomplete="off" spellcheck="false">
                <div class="loading" id="loading"></div>
                <div id="searchResults" class="search-results"></div>
            </div>
            <div class="coordinate-hint">
                💡 <strong>Tips:</strong> Gunakan koordinat format -7.2575,112.7521 atau lat:-7.2575,lng:112.7521
            </div>
        </div>
        
        <!-- Enhanced Status Messages -->
        <div id="status-message" class="status-message"></div>
        
        <!-- Enhanced Error Boundary -->
        <div id="error-boundary" class="error-boundary">
            <h3>⚠️ Terjadi Kesalahan</h3>
            <p>Aplikasi mengalami masalah teknis. Silakan muat ulang halaman untuk melanjutkan.</p>
            <button onclick="location.reload()">🔄 Muat Ulang</button>
        </div>
        
        <!-- External Scripts -->
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2lwdS5wB2neO4JcEkSYjyvI9t1K4KYIs&libraries=places&loading=async"></script>
        
        <!-- Primary JavaScript - Leaflet from CDN -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
        
        <!-- Optional QGIS2Web Scripts with fallbacks -->
        <script>
            // Function to safely load JS files
            function loadJS(src, callback) {
                const script = document.createElement('script');
                script.src = src;
                script.onload = callback || function() {};
                script.onerror = function() {
                    console.warn(`Failed to load JS: ${src}`);
                    if (callback) callback();
                };
                document.head.appendChild(script);
            }
            
            // Enhanced error handling for missing dependencies
            window.onerror = function(msg, url, lineNo, columnNo, error) {
                console.error('Error: ', {msg, url, lineNo, columnNo, error});
                // Only show error boundary for critical errors, not missing resources
                if (msg.includes('infinite number of tiles')) {
                    showErrorBoundary();
                }
                return false;
            };
            
            window.addEventListener('unhandledrejection', function(event) {
                console.error('Unhandled promise rejection:', event.reason);
                showStatusMessage('Terjadi kesalahan saat memuat data', 'error');
            });
            
            function showErrorBoundary() {
                document.getElementById('error-boundary').style.display = 'block';
            }
        </script>
        
        <!-- Load optional scripts -->
        <script>
            const optionalScripts = [
                'js/qgis2web_expressions.js',
                'js/L.Control.Layers.Tree.min.js',
                'js/L.Control.Locate.min.js',
                'js/leaflet.rotatedMarker.js',
                'js/leaflet.pattern.js',
                'js/Autolinker.min.js',
                'js/rbush.min.js',
                'js/labelgun.min.js',
                'js/labels.js',
                'js/leaflet.photon.js',
                'js/leaflet-measure.js',
                'js/proj4.js',
                'js/proj4leaflet.js'
            ];
            
            optionalScripts.forEach(src => loadJS(src));
        </script>
        
        <!-- Data Loading -->
        <script src="data/RumahIbadah_3.js"></script>
        
        <!-- Enhanced Fallback Data -->
        <script>
            if (typeof json_RumahIbadah_3 === 'undefined') {
                var json_RumahIbadah_3 = {
                    "type": "FeatureCollection",
                    "features": [
                        {
                            "type": "Feature",
                            "properties": {
                                "1": "Masjid Ampel",
                                "2": "-7.229167, 112.740556",
                                "3": "Jl. Ampel Masjid No.1, Ampel, Semampir, Surabaya",
                                "4": "Masjid",
                                "5": "Ampel",
                                "6": "Semampir",
                                "7": "H. Ahmad",
                                "8": "031-3291045",
                                "9": "Tanah Wakaf",
                                "NAMA": "Masjid Ampel",
                                "ALAMAT": "Jl. Ampel Masjid No.1, Ampel, Semampir, Surabaya",
                                "KOORDINAT": "-7.229167, 112.740556",
                                "JENIS_TEMP": "Masjid",
                                "KECAMATAN": "Semampir",
                                "KELURAHAN": "Ampel",
                                "TELEPON": "031-3291045"
                            },
                            "geometry": {
                                "type": "Point",
                                "coordinates": [112.740556, -7.229167]
                            }
                        },
                        {
                            "type": "Feature",
                            "properties": {
                                "1": "Gereja Katolik Santa Maria",
                                "2": "-7.257472, 112.752090",
                                "3": "Jl. Kepanjen No.2-8, Krembangan Utara, Krembangan, Surabaya",
                                "4": "Gereja Katolik",
                                "5": "Krembangan Utara",
                                "6": "Krembangan",
                                "7": "Pastor Johannes",
                                "8": "031-3291234",
                                "9": "Tanah Gereja",
                                "NAMA": "Gereja Katolik Santa Maria",
                                "ALAMAT": "Jl. Kepanjen No.2-8, Krembangan Utara, Krembangan, Surabaya",
                                "KOORDINAT": "-7.257472, 112.752090",
                                "JENIS_TEMP": "Gereja Katolik",
                                "KECAMATAN": "Krembangan",
                                "KELURAHAN": "Krembangan Utara",
                                "TELEPON": "031-3291234"
                            },
                            "geometry": {
                                "type": "Point",
                                "coordinates": [112.752090, -7.257472]
                            }
                        }
                    ]
                };
                console.warn('File data/RumahIbadah_3.js tidak ditemukan, menggunakan data sample yang diperluas');
            }
        </script>

        <!-- Main Application Script -->
        <script>
            'use strict';
            
            // ================= APPLICATION STATE =================
            class MapApplication {
                constructor() {
                    this.map = null;
                    this.highlightLayer = null;
                    this.currentSearchMarker = null;
                    this.allFeatures = [];
                    this.autolinker = null;
                    this.searchTimeout = null;
                    this.isDragging = false;
                    this.layers = {};
                    
                    // Bind methods
                    this.handleSearchInput = this.handleSearchInput.bind(this);
                    this.handleSearchKeydown = this.handleSearchKeydown.bind(this);
                    this.hideSearchResults = this.hideSearchResults.bind(this);
                    this.resetHighlight = this.resetHighlight.bind(this);
                    this.highlightFeature = this.highlightFeature.bind(this);
                }
                
                // ================= INITIALIZATION =================
                async initialize() {
                    try {
                        showStatusMessage('🗺️ Memuat peta rumah ibadah...', 'info');
                        
                        // Initialize core dependencies
                        this.autolinker = typeof Autolinker !== 'undefined' 
                            ? new Autolinker({truncate: {length: 30, location: 'smart'}}) 
                            : { link: (text) => text };
                        
                        // Initialize map components
                        this.initializeMap();
                        this.initializeLayers();
                        this.initializeControls();
                        this.initializeEventListeners();
                        this.initializeDragDrop();
                        
                        // Initialize search functionality
                        await this.initializeGooglePlaces();
                        
                        // Setup global functions for onclick events
                        window.selectSuggestion = this.selectSuggestion.bind(this);
                        window.performSearch = this.performSearch.bind(this);
                        
                        showStatusMessage('✅ Peta berhasil dimuat!', 'success');
                        setTimeout(() => hideStatusMessage(), 3000);
                        
                        this.logInitializationStats();
                        
                    } catch (error) {
                        console.error('Initialization error:', error);
                        showStatusMessage('❌ Gagal memuat peta', 'error');
                        showErrorBoundary();
                    }
                }
                
                initializeMap() {
                    // Create map without problematic hash control
                    this.map = L.map('map', {
                        zoomControl: false,
                        maxZoom: 18,
                        minZoom: 8,
                        preferCanvas: false, // Disable canvas to avoid tile loading issues
                        worldCopyJump: true,
                        center: [-7.2575, 112.7521],
                        zoom: 12
                    });
                    
                    // Set attribution without hash
                    this.map.attributionControl.setPrefix(
                        '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
                        '<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; ' +
                        '<a href="https://qgis.org">QGIS</a>'
                    );
                    
                    console.log('Map initialized successfully');
                }
                
                initializeLayers() {
                    // Create map panes with proper z-index
                    const panes = [
                        { name: 'pane_Positron_0', zIndex: 400 },
                        { name: 'pane_GoogleRoad_1', zIndex: 401 },
                        { name: 'pane_GoogleSatellite_2', zIndex: 402 },
                        { name: 'pane_RumahIbadah_3', zIndex: 403 }
                    ];
                    
                    panes.forEach(pane => {
                        this.map.createPane(pane.name);
                        this.map.getPane(pane.name).style.zIndex = pane.zIndex;
                    });
                    
                    // Initialize base layers
                    this.layers.positron = L.tileLayer('https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', {
                        pane: 'pane_Positron_0',
                        opacity: 1.0,
                        attribution: '<a href="https://cartodb.com/basemaps/">Map tiles by CartoDB, under CC BY 3.0. Data by OpenStreetMap, under ODbL.</a>',
                        minZoom: 1,
                        maxZoom: 28,
                        minNativeZoom: 0,
                        maxNativeZoom: 20
                    });
                    
                    this.layers.googleRoad = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                        pane: 'pane_GoogleRoad_1',
                        opacity: 1.0,
                        attribution: '<a href="https://www.google.at/permissions/geoguidelines/attr-guide.html">Map data ©2015 Google</a>',
                        minZoom: 1,
                        maxZoom: 28,
                        minNativeZoom: 0,
                        maxNativeZoom: 20
                    });
                    
                    this.layers.googleSatellite = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                        pane: 'pane_GoogleSatellite_2',
                        opacity: 1.0,
                        attribution: '<a href="https://www.google.at/permissions/geoguidelines/attr-guide.html">Map data ©2015 Google</a>',
                        minZoom: 1,
                        maxZoom: 28,
                        minNativeZoom: 0,
                        maxNativeZoom: 20
                    });
                    
                    // Add default base layer
                    this.map.addLayer(this.layers.positron);
                    
                    // Setup rumah ibadah layer
                    this.map.getPane('pane_RumahIbadah_3').style['mix-blend-mode'] = 'normal';
                    
                    this.layers.rumahIbadah = new L.geoJson(json_RumahIbadah_3, {
                        attribution: '',
                        interactive: true,
                        dataVar: 'json_RumahIbadah_3',
                        layerName: 'layer_RumahIbadah_3',
                        pane: 'pane_RumahIbadah_3',
                        onEachFeature: (feature, layer) => {
                            this.allFeatures.push({ feature: feature, layer: layer });
                            this.setupPopup(feature, layer);
                        },
                        pointToLayer: (feature, latlng) => {
                            return L.marker(latlng, this.getMarkerStyle(feature));
                        }
                    });
                    
                    this.map.addLayer(this.layers.rumahIbadah);
                    
                    // Setup layer controls
                    this.initializeLayerControls();
                    
                    // Set initial bounds
                    this.setBounds();
                }
                
                initializeLayerControls() {
                    const overlaysTree = [
                        {
                            label: 'Rumah Ibadah<br /><table><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Gereja0.png" /></td><td>Gereja</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_GerejaKatolik1.png" /></td><td>Gereja Katolik</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Klenteng2.png" /></td><td>Klenteng</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Masjid3.png" /></td><td>Masjid</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Musholla4.png" /></td><td>Musholla</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Pura5.png" /></td><td>Pura</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Vihara6.png" /></td><td>Vihara</td></tr></table>',
                            layer: this.layers.rumahIbadah
                        },
                        { label: "Google Satellite", layer: this.layers.googleSatellite, radioGroup: 'bm' },
                        { label: "Google Road", layer: this.layers.googleRoad, radioGroup: 'bm' },
                        { label: "Positron", layer: this.layers.positron, radioGroup: 'bm' }
                    ];
                    
                    try {
                        if (typeof L.control.layers.tree !== 'undefined') {
                            const layerControl = L.control.layers.tree(null, overlaysTree, { collapsed: true });
                            layerControl.addTo(this.map);
                        } else {
                            // Fallback to standard layer control
                            const baseLayers = {
                                "Positron": this.layers.positron,
                                "Google Road": this.layers.googleRoad,
                                "Google Satellite": this.layers.googleSatellite
                            };
                            const overlayLayers = {
                                "Rumah Ibadah": this.layers.rumahIbadah
                            };
                            L.control.layers(baseLayers, overlayLayers).addTo(this.map);
                        }
                    } catch (error) {
                        console.warn('Layer control initialization failed:', error);
                    }
                }
                
                initializeControls() {
                    // Zoom control
                    L.control.zoom({ position: 'topleft' }).addTo(this.map);
                    
                    // Location control
                    try {
                        if (typeof L.control.locate !== 'undefined') {
                            L.control.locate({ 
                                position: 'topleft',
                                locateOptions: { maxZoom: 19 },
                                showCompass: true,
                                showPopup: false
                            }).addTo(this.map);
                        }
                    } catch (error) {
                        console.warn('Location control tidak tersedia:', error);
                    }
                    
                    // Measure control
                    try {
                        if (typeof L.Control.Measure !== 'undefined') {
                            const measureControl = new L.Control.Measure({ 
                                position: 'topleft',
                                primaryLengthUnit: 'meters',
                                secondaryLengthUnit: 'kilometers',
                                primaryAreaUnit: 'sqmeters',
                                secondaryAreaUnit: 'hectares'
                            });
                            measureControl.addTo(this.map);
                        }
                    } catch (error) {
                        console.warn('Measure control tidak tersedia:', error);
                    }
                }
                
                setBounds() {
                    try {
                        if (this.layers.rumahIbadah && this.layers.rumahIbadah.getLayers().length > 0) {
                            const bounds = this.layers.rumahIbadah.getBounds();
                            // Check if bounds are valid before fitting
                            if (bounds.isValid()) {
                                this.map.fitBounds(bounds, { 
                                    padding: [20, 20],
                                    maxZoom: 15 // Prevent zooming too far
                                });
                                console.log('Map bounds set successfully');
                            } else {
                                // Fallback to default Surabaya view
                                this.map.setView([-7.2575, 112.7521], 12);
                                console.log('Using default Surabaya coordinates');
                            }
                        } else {
                            // No features loaded, use default view
                            this.map.setView([-7.2575, 112.7521], 12);
                            console.log('No features found, using default view');
                        }
                    } catch (error) {
                        console.warn('Error setting bounds:', error);
                        this.map.setView([-7.2575, 112.7521], 12);
                    }
                }
                
                // ================= MARKER STYLING =================
                getMarkerStyle(feature) {
                    const iconConfig = this.getIconConfig(feature.properties['JENIS_TEMP'] || feature.properties['4']);
                    
                    return {
                        pane: 'pane_RumahIbadah_3',
                        rotationAngle: 0.0,
                        rotationOrigin: 'center center',
                        icon: L.icon({
                            iconUrl: iconConfig.url,
                            iconSize: iconConfig.size,
                            iconAnchor: iconConfig.anchor,
                            popupAnchor: [0, -iconConfig.anchor[1]],
                            className: 'custom-marker'
                        }),
                        interactive: true
                    };
                }
                
                getIconConfig(jenisTemp) {
                    const configs = {
                        'Gereja': {
                            url: 'markers/RumahIbadah_Gereja.svg',
                            size: [15.2, 15.2],
                            anchor: [7.6, 7.6]
                        },
                        'Gereja Katolik': {
                            url: 'legend/RumahIbadah_3_GerejaKatolik1.png',
                            size: [15.2, 15.2],
                            anchor: [7.6, 7.6]
                        },
                        'Klenteng': {
                            url: 'legend/RumahIbadah_3_Klenteng2.png',
                            size: [15.2, 15.2],
                            anchor: [7.6, 7.6]
                        },
                        'Masjid': {
                            url: 'legend/RumahIbadah_3_Masjid3.png',
                            size: [15.2, 15.2],
                            anchor: [7.6, 7.6]
                        },
                        'Musholla': {
                            url: 'legend/RumahIbadah_3_Musholla4.png',
                            size: [15.2, 15.2],
                            anchor: [7.6, 7.6]
                        },
                        'Pura': {
                            url: 'markers/RumahIbadah_hindu.svg',
                            size: [15.2, 15.2],
                            anchor: [7.6, 7.6]
                        },
                        'Vihara': {
                            url: 'markers/RumahIbadah_3.svg',
                            size: [15.2, 15.2],
                            anchor: [7.6, 7.6]
                        }
                    };
                    
                    return configs[String(jenisTemp)] || {
                        url: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png',
                        size: [25, 41],
                        anchor: [12, 41]
                    };
                }
                
                // ================= POPUP AND HIGHLIGHTING =================
                setupPopup(feature, layer) {
                    layer.on({
                        mouseout: this.resetHighlight,
                        mouseover: this.highlightFeature
                    });
                    
                    const popupContent = this.generatePopupContent(feature);
                    const processedContent = this.removeEmptyRowsFromPopupContent(popupContent, feature);
                    
                    layer.on('popupopen', (e) => {
                        this.addClassToPopupIfMedia(processedContent, e.popup);
                    });
                    
                    layer.bindPopup(processedContent, { 
                        maxHeight: 450,
                        maxWidth: 350,
                        autoPan: true,
                        closeButton: true,
                        className: 'enhanced-popup'
                    });
                }
                
                generatePopupContent(feature) {
                    const props = feature.properties;
                    const fields = [
                        { key: 'NAMA', label: '🏛️ Nama', value: props['NAMA'] || props['1'] },
                        { key: 'JENIS_TEMP', label: '⛪ Jenis', value: props['JENIS_TEMP'] || props['4'] },
                        { key: 'ALAMAT', label: '📍 Alamat', value: props['ALAMAT'] || props['3'] },
                        { key: 'KELURAHAN', label: '🏘️ Kelurahan', value: props['KELURAHAN'] || props['5'] },
                        { key: 'KECAMATAN', label: '🏙️ Kecamatan', value: props['KECAMATAN'] || props['6'] },
                        { key: 'PETUGAS', label: '👤 Petugas', value: props['PETUGAS'] || props['7'] },
                        { key: 'TELEPON', label: '📞 Telepon', value: props['TELEPON'] || props['8'] },
                        { key: 'ALAS_HAK', label: '📋 Alas Hak', value: props['ALAS_HAK'] || props['9'] },
                        { key: 'KOORDINAT', label: '🗺️ Koordinat', value: props['KOORDINAT'] || props['2'] }
                    ];
                    
                    let content = '<table>';
                    fields.forEach(field => {
                        if (field.value && field.value !== null && field.value !== '') {
                            const processedValue = this.autolinker.link(String(field.value).replace(/'/g, '\''));
                            content += `<tr><th scope="row">${field.label}</th><td>${processedValue}</td></tr>`;
                        }
                    });
                    
                    // Di dalam metode generatePopupContent(feature)
                    const fotoFields = ['Foto', 'foto', 'FOTO', 'Photo', 'photo', 'PHOTO', 'HALO'];
                    let fotoPath = null;

                    for (const field of fotoFields) {
                        if (props[field] && props[field] !== null && props[field] !== '') {
                            // Buat nama file sesuai format lama Anda (replace \ / : dengan _)
                            const fileName = String(props[field])
                                .replace(/[\\/:]/g, '_')
                                .trim();
                            // Gabungkan dengan path web
                            fotoPath = `images/${fileName}`;
                            break;
                        }
                    }

                    if (fotoPath) {
                        content += `<tr>
                            <th scope="row">📷 Foto</th>
                            <td>
                                <div class="popup-image-container">
                                    <img class="popup-image" 
                                        src="${this.escapeHtml(fotoPath)}" 
                                        alt="Foto ${this.escapeHtml(props['NAMA'] || props['1'] || '')}" 
                                        onload="this.style.display='block';"
                                        onerror="this.parentNode.innerHTML='<div class=&quot;image-placeholder&quot;><span class=&quot;image-error-icon&quot;>🖼️</span><div>Foto tidak tersedia</div></div>';"/>
                                </div>
                            </td>
                        </tr>`;
                    }
                    content += '</table>';
                    
                    // Add coordinates link
                    if (props['KOORDINAT'] || props['2']) {
                        const coords = props['KOORDINAT'] || props['2'];
                        const [lat, lng] = coords.split(',').map(Number);
                        content += `<div class="popup-coordinates">
                            <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lng}" target="_blank">
                                Buka di Google Maps
                            </a>
                        </div>`;
                    }
                    
                    return content;
                }
                
                highlightFeature(e) {
                    this.highlightLayer = e.target;
                    
                    if (this.highlightLayer.feature.geometry.type === 'Point') {
                        if (!this.highlightLayer.originalIcon) {
                            this.highlightLayer.originalIcon = this.highlightLayer.options.icon;
                        }
                        
                        const highlightedIcon = L.icon({
                            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-red.png',
                            iconSize: [30, 48],
                            iconAnchor: [15, 48],
                            popupAnchor: [1, -42],
                            className: 'highlighted-marker'
                        });
                        
                        this.highlightLayer.setIcon(highlightedIcon);
                    } else {
                        this.highlightLayer.setStyle({
                            color: '#ffff00',
                            fillColor: '#ffff00',
                            fillOpacity: 1
                        });
                    }
                }
                
                resetHighlight(e) {
                    const layer = e.target;
                    
                    if (layer.feature.geometry.type === 'Point') {
                        if (layer.originalIcon) {
                            layer.setIcon(layer.originalIcon);
                        } else {
                            layer.setIcon(this.getMarkerStyle(layer.feature).icon);
                        }
                    } else {
                        // Reset style for non-point features
                        for (const i in layer._eventParents) {
                            if (typeof layer._eventParents[i].resetStyle === 'function') {
                                layer._eventParents[i].resetStyle(layer);
                            }
                        }
                    }
                }
                
                // ================= POPUP UTILITIES =================
                removeEmptyRowsFromPopupContent(content, feature) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    const rows = tempDiv.querySelectorAll('tr');
                    
                    rows.forEach(row => {
                        const td = row.querySelector('td.visible-with-data');
                        const key = td ? td.id : '';
                        if (td && td.classList.contains('visible-with-data') && !feature.properties[key]) {
                            row.remove();
                        }
                    });
                    
                    return tempDiv.innerHTML;
                }
                
                addClassToPopupIfMedia(content, popup) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = content;
                    
                    if (tempDiv.querySelector('td img')) {
                        popup._contentNode.classList.add('media');
                        setTimeout(() => popup.update(), 10);
                    } else {
                        popup._contentNode.classList.remove('media');
                    }
                }
                
                // ================= COORDINATE PARSING =================
                parseCoordinates(searchTerm) {
                    const term = searchTerm.trim();
                    
                    // Format: lat,lng atau lat, lng
                    let match = term.match(/^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/);
                    if (match) {
                        return {
                            lat: parseFloat(match[1]),
                            lng: parseFloat(match[2]),
                            isValid: true
                        };
                    }
                    
                    // Format: lat:-7.2575,lng:112.7521
                    match = term.match(/lat:\s*(-?\d+\.?\d*),?\s*lng:\s*(-?\d+\.?\d*)/i);
                    if (match) {
                        return {
                            lat: parseFloat(match[1]),
                            lng: parseFloat(match[2]),
                            isValid: true
                        };
                    }
                    
                    // Format: lng:112.7521,lat:-7.2575 (reversed)
                    match = term.match(/lng:\s*(-?\d+\.?\d*),?\s*lat:\s*(-?\d+\.?\d*)/i);
                    if (match) {
                        return {
                            lat: parseFloat(match[2]),
                            lng: parseFloat(match[1]),
                            isValid: true
                        };
                    }
                    
                    return { isValid: false };
                }
                
                isValidCoordinateRange(lat, lng) {
                    // Surabaya coordinate boundaries with some tolerance
                    return (lat >= -8.0 && lat <= -6.5 && lng >= 112.0 && lng <= 113.5);
                }
                
                // ================= SEARCH FUNCTIONALITY =================
                performSearch(searchTerm) {
                    if (!searchTerm || searchTerm.trim().length === 0) {
                        return;
                    }
                    
                    showLoading(true);
                    const searchLower = searchTerm.toLowerCase().trim();
                    
                    // Check if input is coordinates
                    const coords = this.parseCoordinates(searchTerm);
                    if (coords.isValid) {
                        this.searchByCoordinates(coords.lat, coords.lng);
                        showLoading(false);
                        return;
                    }
                    
                    // Search in worship places data
                    const foundFeature = this.findFeatureByText(searchLower);
                    
                    if (foundFeature) {
                        this.focusOnFeature(foundFeature);
                        showStatusMessage(`✅ Ditemukan: ${foundFeature.feature.properties.NAMA || foundFeature.feature.properties['1']}`, 'success');
                        showLoading(false);
                    } else {
                        // Fallback to Google geocoding
                        this.searchByAddressGoogle(searchTerm);
                    }
                }
                
                findFeatureByText(searchLower) {
                    return this.allFeatures.find(item => {
                        const props = item.feature.properties;
                        const searchFields = [
                            props.NAMA || props['1'] || '',
                            props.ALAMAT || props['3'] || '',
                            props.JENIS_TEMP || props['4'] || '',
                            props.KECAMATAN || props['6'] || '',
                            props.KELURAHAN || props['5'] || ''
                        ];
                        
                        return searchFields.some(field => 
                            String(field).toLowerCase().includes(searchLower)
                        );
                    });
                }
                
                focusOnFeature(foundFeature) {
                    const coords = foundFeature.feature.geometry.coordinates;
                    const latlng = [coords[1], coords[0]];
                    
                    this.map.setView(latlng, 17);
                    this.removeCurrentSearchMarker();
                    
                    setTimeout(() => {
                        foundFeature.layer.openPopup();
                    }, 500);
                }
                
                searchByCoordinates(lat, lng) {
                    if (!this.isValidCoordinateRange(lat, lng)) {
                        showStatusMessage('⚠️ Koordinat berada di luar area Surabaya', 'error');
                        return;
                    }
                    
                    const latlng = [lat, lng];
                    this.removeCurrentSearchMarker();
                    
                    this.currentSearchMarker = L.marker(latlng, {
                        icon: L.icon({
                            iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-green.png',
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            className: 'search-result-marker'
                        })
                    }).addTo(this.map);
                    
                    this.currentSearchMarker.bindPopup(
                        `<div style="text-align: center;">
                            <strong>📍 Koordinat yang Dicari</strong><br><br>
                            <div style="background: #f8fafc; padding: 10px; border-radius: 8px; margin: 8px 0;">
                                <div><strong>Latitude:</strong> ${lat}</div>
                                <div><strong>Longitude:</strong> ${lng}</div>
                            </div>
                            <small style="color: #64748b;">Klik pada peta untuk menutup</small>
                         </div>`
                    ).openPopup();
                    
                    this.map.setView(latlng, 16);
                    showStatusMessage(`📍 Lokasi ditemukan: ${lat}, ${lng}`, 'success');
                }
                
                async searchByAddressGoogle(address) {
                    try {
                        if (typeof google === 'undefined' || !google.maps || !google.maps.Geocoder) {
                            throw new Error('Google Maps API tidak tersedia');
                        }
                        
                        const geocoder = new google.maps.Geocoder();
                        const searchAddress = `${address}, Surabaya, East Java, Indonesia`;
                        
                        const results = await new Promise((resolve, reject) => {
                            geocoder.geocode({'address': searchAddress}, (results, status) => {
                                if (status === 'OK' && results.length > 0) {
                                    resolve(results);
                                } else {
                                    reject(new Error(`Geocoding failed: ${status}`));
                                }
                            });
                        });
                        
                        const lat = results[0].geometry.location.lat();
                        const lng = results[0].geometry.location.lng();
                        const latlng = [lat, lng];
                        
                        this.removeCurrentSearchMarker();
                        
                        this.currentSearchMarker = L.marker(latlng, {
                            icon: L.icon({
                                iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-green.png',
                                iconSize: [25, 41],
                                iconAnchor: [12, 41],
                                popupAnchor: [1, -34],
                                className: 'search-result-marker'
                            })
                        }).addTo(this.map);
                        
                        this.currentSearchMarker.bindPopup(
                            `<div style="text-align: center;">
                                <strong>🔍 Hasil Pencarian</strong><br><br>
                                <div style="background: #f0f9ff; padding: 10px; border-radius: 8px; border: 1px solid #0ea5e9;">
                                    ${results[0].formatted_address}
                                </div>
                                <small style="color: #64748b; margin-top: 8px; display: block;">Via Google Geocoding</small>
                             </div>`
                        ).openPopup();
                        
                        this.map.setView(latlng, 16);
                        showStatusMessage('🌐 Lokasi ditemukan dengan Google Geocoding', 'success');
                        showLoading(false);
                        
                    } catch (error) {
                        console.error('Google geocoding error:', error);
                        showStatusMessage(`❌ Lokasi "${address}" tidak ditemukan`, 'error');
                        showLoading(false);
                    }
                }
                
                removeCurrentSearchMarker() {
                    if (this.currentSearchMarker) {
                        this.map.removeLayer(this.currentSearchMarker);
                        this.currentSearchMarker = null;
                    }
                }
                
                // ================= SEARCH SUGGESTIONS =================
                showSearchSuggestions(searchTerm) {
                    const resultsContainer = document.getElementById('searchResults');
                    const searchLower = searchTerm.toLowerCase().trim();
                    
                    if (searchTerm.length < 2) {
                        this.hideSearchResults();
                        return;
                    }
                    
                    // Check for coordinate input
                    const coords = this.parseCoordinates(searchTerm);
                    if (coords.isValid) {
                        const isValidRange = this.isValidCoordinateRange(coords.lat, coords.lng);
                        const statusText = isValidRange ? '✅ Valid untuk Surabaya' : '⚠️ Di luar area Surabaya';
                        const statusColor = isValidRange ? '#16a34a' : '#dc2626';
                        
                        resultsContainer.innerHTML = `
                            <div class="search-result-item" onclick="performSearch('${searchTerm}')">
                                <strong>📍 Koordinat: ${coords.lat}, ${coords.lng}</strong><br>
                                <small style="color: ${statusColor}; font-weight: 500;">${statusText}</small>
                            </div>
                        `;
                        resultsContainer.style.display = 'block';
                        return;
                    }
                    
                    // Generate suggestions from worship places data
                    const suggestions = this.generateSuggestions(searchLower);
                    
                    if (suggestions.length > 0) {
                        let html = '';
                        suggestions.forEach((suggestion, index) => {
                            const typeIcon = this.getTypeIcon(suggestion.jenis);
                            html += `<div class="search-result-item" onclick="selectSuggestion('${this.escapeHtml(suggestion.name)}')">
                                        <strong>${typeIcon} ${this.escapeHtml(suggestion.displayText)}</strong><br>
                                        <small style="color: #6b7280;">📍 ${this.escapeHtml(suggestion.kecamatan || 'Surabaya')}</small>
                                    </div>`;
                        });
                        resultsContainer.innerHTML = html;
                        resultsContainer.style.display = 'block';
                    } else {
                        resultsContainer.innerHTML = '<div class="search-result-item" style="color: #9ca3af; cursor: default;">🔍 Tidak ada hasil dalam data lokal<br><small>Coba gunakan Google Places atau koordinat</small></div>';
                        resultsContainer.style.display = 'block';
                    }
                }
                
                getTypeIcon(jenisTemp) {
                    const icons = {
                        'Masjid': '🕌',
                        'Musholla': '🕌',
                        'Gereja': '⛪',
                        'Gereja Katolik': '⛪',
                        'Klenteng': '🏛️',
                        'Vihara': '🏯',
                        'Pura': '🛕'
                    };
                    return icons[jenisTemp] || '🏛️';
                }
                
                generateSuggestions(searchLower) {
                    const suggestions = [];
                    
                    this.allFeatures.forEach(item => {
                        if (suggestions.length >= 8) return;
                        
                        const props = item.feature.properties;
                        const nama = props.NAMA || props['1'] || '';
                        const jenis = props.JENIS_TEMP || props['4'] || '';
                        const alamat = props.ALAMAT || props['3'] || '';
                        const kecamatan = props.KECAMATAN || props['6'] || '';
                        const kelurahan = props.KELURAHAN || props['5'] || '';
                        
                        const searchFields = [nama, jenis, alamat, kecamatan, kelurahan];
                        
                        if (searchFields.some(field => String(field).toLowerCase().includes(searchLower))) {
                            suggestions.push({
                                displayText: `${nama} (${jenis})`,
                                name: nama,
                                jenis: jenis,
                                kecamatan: kecamatan
                            });
                        }
                    });
                    
                    return suggestions;
                }
                
                selectSuggestion(name) {
                    document.getElementById('search-input').value = name;
                    this.performSearch(name);
                    this.hideSearchResults();
                }
                
                hideSearchResults() {
                    document.getElementById('searchResults').style.display = 'none';
                }
                
                escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
                
                // ================= EVENT HANDLERS =================
                initializeEventListeners() {
                    const searchInput = document.getElementById('search-input');
                    
                    // Debounced search input
                    searchInput.addEventListener('input', (e) => {
                        clearTimeout(this.searchTimeout);
                        this.searchTimeout = setTimeout(() => {
                            this.showSearchSuggestions(e.target.value);
                        }, 300);
                    });
                    
                    searchInput.addEventListener('keydown', this.handleSearchKeydown);
                    
                    // Close results when clicking outside
                    document.addEventListener('click', (e) => {
                        const searchCard = document.getElementById('search-card');
                        if (!searchCard.contains(e.target)) {
                            this.hideSearchResults();
                        }
                    });
                    
                    // Handle window resize
                    window.addEventListener('resize', this.debounce(() => {
                        if (this.map) {
                            this.map.invalidateSize();
                        }
                    }, 250));
                }
                
                handleSearchInput(e) {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        this.showSearchSuggestions(e.target.value);
                    }, 300);
                }
                
                handleSearchKeydown(e) {
                    switch (e.key) {
                        case 'Enter':
                            e.preventDefault();
                            this.performSearch(e.target.value);
                            this.hideSearchResults();
                            break;
                        case 'Escape':
                            this.hideSearchResults();
                            e.target.blur();
                            break;
                    }
                }
                
                // ================= DRAG AND DROP FUNCTIONALITY =================
                initializeDragDrop() {
                    const searchCard = document.getElementById('search-card');
                    const handle = searchCard.querySelector('.card-handle');
                    let startX, startY, startLeft, startTop;
                    
                    const handleMouseDown = (e) => {
                        this.isDragging = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        const rect = searchCard.getBoundingClientRect();
                        startLeft = rect.left;
                        startTop = rect.top;
                        searchCard.style.cursor = 'grabbing';
                        handle.style.opacity = '1';
                        e.preventDefault();
                    };
                    
                    const handleMouseMove = (e) => {
                        if (!this.isDragging) return;
                        e.preventDefault();
                        const dx = e.clientX - startX;
                        const dy = e.clientY - startY;
                        searchCard.style.left = (startLeft + dx) + 'px';
                        searchCard.style.top = (startTop + dy) + 'px';
                        searchCard.style.transform = 'none';
                    };
                    
                    const handleMouseUp = () => {
                        if (this.isDragging) {
                            this.isDragging = false;
                            searchCard.style.cursor = 'grab';
                            handle.style.opacity = '0.7';
                        }
                    };
                    
                    handle.addEventListener('mousedown', handleMouseDown);
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                    
                    // Touch support for mobile
                    handle.addEventListener('touchstart', (e) => {
                        const touch = e.touches[0];
                        handleMouseDown({
                            clientX: touch.clientX,
                            clientY: touch.clientY,
                            preventDefault: () => e.preventDefault()
                        });
                    });
                    
                    document.addEventListener('touchmove', (e) => {
                        if (this.isDragging) {
                            const touch = e.touches[0];
                            handleMouseMove({
                                clientX: touch.clientX,
                                clientY: touch.clientY,
                                preventDefault: () => e.preventDefault()
                            });
                        }
                    });
                    
                    document.addEventListener('touchend', handleMouseUp);
                }
                
                // ================= GOOGLE PLACES INTEGRATION =================
                async initializeGooglePlaces() {
                    try {
                        if (typeof google === 'undefined' || !google.maps || !google.maps.places) {
                            console.warn('Google Places API tidak tersedia');
                            return;
                        }
                        
                        const searchInput = document.getElementById('search-input');
                        const autocomplete = new google.maps.places.Autocomplete(searchInput, {
                            componentRestrictions: {country: 'ID'},
                            bounds: new google.maps.LatLngBounds(
                                new google.maps.LatLng(-7.35, 112.5),
                                new google.maps.LatLng(-7.15, 112.95)
                            ),
                            strictBounds: false,
                            types: ['establishment']
                        });
                        
                        autocomplete.addListener('place_changed', () => {
                            const place = autocomplete.getPlace();
                            if (place.geometry) {
                                this.hideSearchResults();
                                const lat = place.geometry.location.lat();
                                const lng = place.geometry.location.lng();
                                
                                this.removeCurrentSearchMarker();
                                
                                this.currentSearchMarker = L.marker([lat, lng], {
                                    icon: L.icon({
                                        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-green.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41],
                                        popupAnchor: [1, -34],
                                        className: 'google-places-marker'
                                    })
                                }).addTo(this.map);
                                
                                this.currentSearchMarker.bindPopup(
                                    `<div style="text-align: center;">
                                        <strong>🌐 ${place.name}</strong><br><br>
                                        <div style="background: #ecfdf5; padding: 10px; border-radius: 8px; border: 1px solid #10b981;">
                                            ${place.formatted_address}
                                        </div>
                                        <small style="color: #64748b; margin-top: 8px; display: block;">Via Google Places</small>
                                     </div>`
                                ).openPopup();
                                
                                this.map.setView([lat, lng], 16);
                                showStatusMessage('✅ Lokasi ditemukan dengan Google Places', 'success');
                            }
                        });
                        
                    } catch (error) {
                        console.warn('Google Places Autocomplete initialization failed:', error);
                    }
                }
                
                // ================= UTILITY FUNCTIONS =================
                debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }
                
                logInitializationStats() {
                    console.log('🗺️ Peta Rumah Ibadah Surabaya berhasil dimuat');
                    console.log(`📊 Total rumah ibadah: ${this.allFeatures.length}`);
                    console.log('🔍 Fitur pencarian koordinat tersedia');
                    console.log('📱 Responsive design aktif');
                    console.log('🎯 Format koordinat yang didukung:');
                    console.log('   • lat,lng: -7.2575,112.7521');
                    console.log('   • lat: -7.2575, lng: 112.7521');
                    console.log('   • lng: 112.7521, lat: -7.2575');
                    
                    // Log layer statistics
                    const jenisCount = {};
                    this.allFeatures.forEach(item => {
                        const jenis = item.feature.properties.JENIS_TEMP || item.feature.properties['4'] || 'Unknown';
                        jenisCount[jenis] = (jenisCount[jenis] || 0) + 1;
                    });
                    
                    console.log('📈 Statistik jenis rumah ibadah:');
                    Object.entries(jenisCount).forEach(([jenis, count]) => {
                        console.log(`   • ${jenis}: ${count}`);
                    });
                }
            }
            
            // ================= ENHANCED IMAGE HANDLING =================
            // Global function to handle image loading errors
            HTMLImageElement.prototype.handleImageError = function(possiblePaths) {
                const img = this;
                const currentIndex = possiblePaths.indexOf(img.src);
                
                if (currentIndex < possiblePaths.length - 1) {
                    // Try next path
                    img.src = possiblePaths[currentIndex + 1];
                } else {
                    // All paths failed, show placeholder
                    img.style.display = 'none';
                    const placeholder = img.parentNode.querySelector('.image-placeholder');
                    if (placeholder) {
                        placeholder.style.display = 'block';
                    }
                }
            };
            
            // ================= UTILITY FUNCTIONS =================
            function showStatusMessage(message, type = 'info') {
                const statusEl = document.getElementById('status-message');
                statusEl.innerHTML = message;
                statusEl.className = `status-message ${type}`;
                statusEl.style.display = 'block';
                
                // Auto-hide based on message type
                const hideDelay = type === 'error' ? 5000 : 3000;
                setTimeout(() => hideStatusMessage(), hideDelay);
            }
            
            function hideStatusMessage() {
                const statusEl = document.getElementById('status-message');
                statusEl.style.display = 'none';
            }
            
            function showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
            }
            
            // ================= APPLICATION INITIALIZATION =================
            let mapApp;
            
            async function initializeApplication() {
                try {
                    showStatusMessage('🚀 Memulai aplikasi peta...', 'info');
                    mapApp = new MapApplication();
                    await mapApp.initialize();
                } catch (error) {
                    console.error('Failed to initialize application:', error);
                    showStatusMessage('❌ Gagal memuat aplikasi', 'error');
                    showErrorBoundary();
                }
            }
            
            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeApplication);
            } else {
                initializeApplication();
            }
            
            // ================= ENHANCED ERROR HANDLING =================
            window.addEventListener('error', (event) => {
                console.error('Global error:', event.error);
                if (event.error && event.error.message && 
                    event.error.message.includes('Cannot read property') && 
                    event.error.message.includes('map')) {
                    showStatusMessage('⚠️ Kesalahan saat memuat peta, mencoba memuat ulang...', 'error');
                    setTimeout(() => location.reload(), 3000);
                }
            });
            
            // ================= PERFORMANCE MONITORING =================
            window.addEventListener('load', () => {
                const loadTime = performance.now();
                console.log(`⚡ Aplikasi dimuat dalam ${Math.round(loadTime)} ms`);
                
                // Log memory usage if available
                if (performance.memory) {
                    console.log(`💾 Memori digunakan: ${Math.round(performance.memory.usedJSHeapSize / 1048576)} MB`);
                }
            });
        </script>
    </body>
</html>