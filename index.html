<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <title>Peta Rumah Ibadah Surabaya</title>
        
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/L.Control.Locate.min.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet-search.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <link rel="stylesheet" href="css/leaflet-measure.css">
        <!-- Fallback CSS untuk Leaflet -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" />

        <style>
            html, body, #map {
                width: 100%;
                height: 100%;
                padding: 0;
                margin: 0;
            }
            
            .search-card {
                position: absolute;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
                background-color: white;
                padding: 10px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                width: 90%;
                max-width: 400px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }
            
            .search-input-container {
                width: 100%;
                position: relative;
            }
            
            #search-input {
                width: 100%;
                padding: 10px 10px 10px 40px;
                border: 1px solid #ccc;
                border-radius: 5px;
                font-size: 16px;
                box-sizing: border-box;
                background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z" fill="%23666666"/></svg>');
                background-repeat: no-repeat;
                background-position: 10px center;
                background-size: 20px;
            }
            
            #search-input:focus {
                outline: none;
                border-color: #4285F4;
            }
            
            .card-handle {
                width: 50px;
                height: 5px;
                background-color: #ccc;
                border-radius: 5px;
                margin-bottom: 10px;
                cursor: grab;
            }
            
            .search-results {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border: 1px solid #ccc;
                border-top: none;
                border-radius: 0 0 4px 4px;
                max-height: 200px;
                overflow-y: auto;
                display: none;
                z-index: 10000;
            }
            
            .search-result-item {
                padding: 8px 12px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
            }
            
            .search-result-item:hover {
                background: #f5f5f5;
            }
            
            .search-result-item:last-child {
                border-bottom: none;
            }
            
            .coordinate-hint {
                font-size: 11px;
                color: #888;
                margin-top: 5px;
                text-align: center;
            }
            
            @media (max-width: 600px) {
                .search-card {
                    width: 95%;
                }
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <div id="search-card" class="search-card">
            <div class="card-handle"></div>
            <div class="search-input-container">
                <input id="search-input" type="text" placeholder="Cari nama, lokasi, atau koordinat (lat,lng)..." autocomplete="off">
                <div id="searchResults" class="search-results"></div>
            </div>
            <div class="coordinate-hint">
                Contoh koordinat: -7.2575,112.7521 atau lat:-7.2575,lng:112.7521
            </div>
        </div>
        
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB2lwdS5wB2neO4JcEkSYjyvI9t1K4KYIs&libraries=places&loading=async"></script>
        
        <!-- QGIS2Web Scripts -->
        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/L.Control.Locate.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>
        <script src="js/leaflet-measure.js"></script>
        <script src="js/proj4.js"></script>
        <script src="js/proj4leaflet.js"></script>
        
        <!-- Fallback Leaflet -->
        <script>
            if (typeof L === 'undefined') {
                document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"><\/script>');
            }
        </script>
        
        <!-- Data Rumah Ibadah -->
        <script src="data/RumahIbadah_3.js"></script>
        
        <!-- Fallback Data -->
        <script>
            if (typeof json_RumahIbadah_3 === 'undefined') {
                var json_RumahIbadah_3 = {
                    "type": "FeatureCollection",
                    "features": [
                        {
                            "type": "Feature",
                            "properties": {
                                "NAMA": "Masjid Ampel",
                                "ALAMAT": "Jl. Ampel Masjid No.1, Ampel, Semampir, Surabaya",
                                "KOORDINAT": "-7.229167, 112.740556",
                                "JENIS_TEMP": "Masjid",
                                "KECAMATAN": "Semampir",
                                "KELURAHAN": "Ampel",
                                "TELEPON": "031-3291045",
                                "Foto": "ampel.jpg"
                            },
                            "geometry": {
                                "type": "Point",
                                "coordinates": [112.740556, -7.229167]
                            }
                        }
                    ]
                };
                console.warn('File data/RumahIbadah_3.js tidak ditemukan, menggunakan data sample');
            }
        </script>

        <script>
            // ================= VARIABEL GLOBAL =================
            var map;
            var highlightLayer;
            var currentSearchMarker = null;
            var allFeatures = [];
            var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
            
            // ================= INISIALISASI PETA =================
            function initializeMap() {
                map = L.map('map', {
                    zoomControl: false,
                    maxZoom: 28,
                    minZoom: 1
                }).setView([-7.2575, 112.7521], 12);
                
                var hash = new L.Hash(map);
                map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');
            }
            
            // ================= LAYER PETA =================
            function initializeLayers() {
                // Base Layers
                map.createPane('pane_Positron_0');
                map.getPane('pane_Positron_0').style.zIndex = 400;
                var layer_Positron_0 = L.tileLayer('https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', { 
                    pane: 'pane_Positron_0', 
                    opacity: 1.0, 
                    attribution: '<a href="https://cartodb.com/basemaps/">Map tiles by CartoDB, under CC BY 3.0. Data by OpenStreetMap, under ODbL.</a>', 
                    minZoom: 1, 
                    maxZoom: 28, 
                    minNativeZoom: 0, 
                    maxNativeZoom: 20
                });
                map.addLayer(layer_Positron_0);

                map.createPane('pane_GoogleRoad_1');
                map.getPane('pane_GoogleRoad_1').style.zIndex = 401;
                var layer_GoogleRoad_1 = L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
                    pane: 'pane_GoogleRoad_1', 
                    opacity: 1.0, 
                    attribution: '<a href="https://www.google.at/permissions/geoguidelines/attr-guide.html">Map data Â©2015 Google</a>', 
                    minZoom: 1, 
                    maxZoom: 28, 
                    minNativeZoom: 0, 
                    maxNativeZoom: 20
                });
                
                map.createPane('pane_GoogleSatellite_2');
                map.getPane('pane_GoogleSatellite_2').style.zIndex = 402;
                var layer_GoogleSatellite_2 = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                    pane: 'pane_GoogleSatellite_2', 
                    opacity: 1.0, 
                    attribution: '<a href="https://www.google.at/permissions/geoguidelines/attr-guide.html">Map data Â©2015 Google</a>', 
                    minZoom: 1, 
                    maxZoom: 28, 
                    minNativeZoom: 0, 
                    maxNativeZoom: 20
                });
                
                // Rumah Ibadah Layer
                map.createPane('pane_RumahIbadah_3');
                map.getPane('pane_RumahIbadah_3').style.zIndex = 403;
                map.getPane('pane_RumahIbadah_3').style['mix-blend-mode'] = 'normal';
                
                var layer_RumahIbadah_3 = new L.geoJson(json_RumahIbadah_3, {
                    attribution: '',
                    interactive: true,
                    dataVar: 'json_RumahIbadah_3',
                    layerName: 'layer_RumahIbadah_3',
                    pane: 'pane_RumahIbadah_3',
                    onEachFeature: function(feature, layer) {
                        allFeatures.push({ feature: feature, layer: layer });
                        setupPopup(feature, layer);
                    },
                    pointToLayer: function (feature, latlng) {
                        return L.marker(latlng, getMarkerStyle(feature));
                    },
                });
                map.addLayer(layer_RumahIbadah_3);

                // Layer Controls
                var overlaysTree = [
                    {label: 'Rumah Ibadah<br /><table><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Gereja0.png" /></td><td>Gereja</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_GerejaKatolik1.png" /></td><td>Gereja Katolik</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Klenteng2.png" /></td><td>Klenteng</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Masjid3.png" /></td><td>Masjid</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Musholla4.png" /></td><td>Musholla</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Pura5.png" /></td><td>Pura</td></tr><tr><td style="text-align: center;"><img src="legend/RumahIbadah_3_Vihara6.png" /></td><td>Vihara</td></tr></table>', layer: layer_RumahIbadah_3},
                    {label: "Google Satellite", layer: layer_GoogleSatellite_2, radioGroup: 'bm' },
                    {label: "Google Road", layer: layer_GoogleRoad_1, radioGroup: 'bm' },
                    {label: "Positron", layer: layer_Positron_0, radioGroup: 'bm' },
                ];
                
                try {
                    var lay = L.control.layers.tree(null, overlaysTree, { collapsed: true });
                    lay.addTo(map);
                } catch(e) {
                    var baseLayers = {
                        "Positron": layer_Positron_0,
                        "Google Road": layer_GoogleRoad_1,
                        "Google Satellite": layer_GoogleSatellite_2
                    };
                    var overlayLayers = {
                        "Rumah Ibadah": layer_RumahIbadah_3
                    };
                    L.control.layers(baseLayers, overlayLayers).addTo(map);
                }

                // Set bounds
                var bounds_group = new L.featureGroup([layer_RumahIbadah_3]);
                if (bounds_group.getLayers().length) {
                    map.fitBounds(bounds_group.getBounds(), {padding: [20, 20]});
                }
            }
            
            // ================= KONTROL PETA =================
            function initializeControls() {
                L.control.zoom({ position: 'topleft' }).addTo(map);
                
                try {
                    L.control.locate({ locateOptions: { maxZoom: 19 } }).addTo(map);
                } catch(e) {
                    console.warn('Control locate tidak tersedia');
                }
                
                try {
                    var measureControl = new L.Control.Measure({ position: 'topleft' });
                    measureControl.addTo(map);
                } catch(e) {
                    console.warn('Measure control tidak tersedia');
                }
            }
            
            // ================= STYLING MARKER (TANPA SHADOW) =================
            function getMarkerStyle(feature) {
                var iconUrl = 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png';
                var iconSize = [25, 41];
                var iconAnchor = [12, 41];
                
                switch(String(feature.properties['JENIS_TEMP'])) {
                    case 'Gereja': 
                        iconUrl = 'markers/RumahIbadah_Gereja.svg';
                        iconSize = [15.2, 15.2]; 
                        iconAnchor = [7.6, 7.6];
                        break;
                    case 'Gereja Katolik':
                        iconUrl = 'legend/RumahIbadah_3_GerejaKatolik1.png';
                        iconSize = [15.2, 15.2]; 
                        iconAnchor = [7.6, 7.6];
                        break;
                    case 'Klenteng': 
                        iconUrl = 'legend/RumahIbadah_3_Klenteng2.png'; 
                        iconSize = [15.2, 15.2]; 
                        iconAnchor = [7.6, 7.6]; 
                        break;
                    case 'Masjid': 
                        iconUrl = 'legend/RumahIbadah_3_Masjid3.png'; 
                        iconSize = [15.2, 15.2]; 
                        iconAnchor = [7.6, 7.6]; 
                        break;
                    case 'Musholla': 
                        iconUrl = 'legend/RumahIbadah_3_Musholla4.png'; 
                        iconSize = [15.2, 15.2]; 
                        iconAnchor = [7.6, 7.6]; 
                        break;
                    case 'Pura': 
                        iconUrl = 'markers/RumahIbadah_hindu.svg'; 
                        iconSize = [15.2, 15.2]; 
                        iconAnchor = [7.6, 7.6]; 
                        break;
                    case 'Vihara': 
                        iconUrl = 'markers/RumahIbadah_3.svg'; 
                        iconSize = [15.2, 15.2]; 
                        iconAnchor = [7.6, 7.6]; 
                        break;
                }
                
                return {
                    pane: 'pane_RumahIbadah_3',
                    rotationAngle: 0.0,
                    rotationOrigin: 'center center',
                    icon: L.icon({
                        iconUrl: iconUrl,
                        iconSize: iconSize,
                        iconAnchor: iconAnchor,
                        popupAnchor: [0, -iconAnchor[1]]
                        // shadowUrl dihapus untuk menghilangkan bayangan
                        // shadowSize dihapus untuk menghilangkan bayangan
                    }),
                    interactive: true,
                };
            }
            
            // ================= POPUP DAN HIGHLIGHT =================
            function setupPopup(feature, layer) {
                layer.on({
                    mouseout: resetHighlight,
                    mouseover: highlightFeature,
                });
                
                var popupContent = '<table>' + 
                    '<tr><th scope="row">Nama</th><td>' + (feature.properties['NAMA'] !== null ? autolinker.link(String(feature.properties['NAMA']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>' + 
                    '<tr><th scope="row">Alamat</th><td>' + (feature.properties['ALAMAT'] !== null ? autolinker.link(String(feature.properties['ALAMAT']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>' +
                    '<tr><th scope="row">Koordinat</th><td>' + (feature.properties['KOORDINAT'] !== null ? autolinker.link(String(feature.properties['KOORDINAT']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>' +
                    '<tr><th scope="row">Jenis Rumah Ibadah</th><td>' + (feature.properties['JENIS_TEMP'] !== null ? autolinker.link(String(feature.properties['JENIS_TEMP']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>' +
                    '<tr><th scope="row">Kecamatan</th><td>' + (feature.properties['KECAMATAN'] !== null ? autolinker.link(String(feature.properties['KECAMATAN']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>' +
                    '<tr><th scope="row">Kelurahan</th><td>' + (feature.properties['KELURAHAN'] !== null ? autolinker.link(String(feature.properties['KELURAHAN']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>' +
                    '<tr><th scope="row">Telepon</th><td>' + (feature.properties['TELEPON'] !== null ? autolinker.link(String(feature.properties['TELEPON']).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>' +
                    '<tr><th scope="row">Foto</th><td>' + (feature.properties['Foto'] !== null ? '<img src="images/' + String(feature.properties['Foto']).replace(/[\\/:]/g, '_').trim().replace(/'/g, '\'').replace(/"/g, '&quot;') + '" style="max-width: 200px; height: auto;">' : '') + '</td></tr>' +
                    '</table>';
                
                var content = removeEmptyRowsFromPopupContent(popupContent, feature);
                layer.on('popupopen', function(e) { addClassToPopupIfMedia(content, e.popup); });
                layer.bindPopup(content, { maxHeight: 400 });
            }

            function highlightFeature(e) {
                highlightLayer = e.target;
                if (highlightLayer.feature.geometry.type === 'Point') {
                    if (!highlightLayer.originalIcon) {
                        highlightLayer.originalIcon = highlightLayer.options.icon;
                    }
                    const highlightedIcon = L.icon({
                        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-red.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                        // shadowUrl dihapus untuk menghilangkan bayangan
                        // shadowSize dihapus untuk menghilangkan bayangan
                    });
                    highlightLayer.setIcon(highlightedIcon);
                } else {
                    highlightLayer.setStyle({
                        color: '#ffff00',
                        fillColor: '#ffff00',
                        fillOpacity: 1
                    });
                }
            }
            
            function resetHighlight(e) {
                var layer = e.target;
                if (layer.feature.geometry.type === 'Point') {
                    if (layer.originalIcon) {
                        layer.setIcon(layer.originalIcon);
                    } else {
                        layer.setIcon(getMarkerStyle(layer.feature).icon);
                    }
                } else {
                    for (var i in layer._eventParents) {
                        if (typeof layer._eventParents[i].resetStyle === 'function') {
                            layer._eventParents[i].resetStyle(layer);
                        }
                    }
                }
            }
            
            // ================= UTILITAS POPUP =================
            function removeEmptyRowsFromPopupContent(content, feature) {
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                var rows = tempDiv.querySelectorAll('tr');
                for (var i = 0; i < rows.length; i++) {
                    var td = rows[i].querySelector('td.visible-with-data');
                    var key = td ? td.id : '';
                    if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                        rows[i].parentNode.removeChild(rows[i]);
                    }
                }
                return tempDiv.innerHTML;
            }
            
            function addClassToPopupIfMedia(content, popup) {
                var tempDiv = document.createElement('div');
                tempDiv.innerHTML = content;
                if (tempDiv.querySelector('td img')) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() { popup.update(); }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            }
            
            // ================= FUNGSI PENCARIAN KOORDINAT =================
            function parseCoordinates(searchTerm) {
                const term = searchTerm.trim();
                
                // Format: lat,lng atau lat, lng
                let match = term.match(/^(-?\d+\.?\d*),\s*(-?\d+\.?\d*)$/);
                if (match) {
                    return {
                        lat: parseFloat(match[1]),
                        lng: parseFloat(match[2]),
                        isValid: true
                    };
                }
                
                // Format: lat:-7.2575,lng:112.7521 atau lat:-7.2575, lng:112.7521
                match = term.match(/lat:\s*(-?\d+\.?\d*),?\s*lng:\s*(-?\d+\.?\d*)/i);
                if (match) {
                    return {
                        lat: parseFloat(match[1]),
                        lng: parseFloat(match[2]),
                        isValid: true
                    };
                }
                
                // Format: longitude,latitude (terbalik)
                match = term.match(/^lng:\s*(-?\d+\.?\d*),?\s*lat:\s*(-?\d+\.?\d*)/i);
                if (match) {
                    return {
                        lat: parseFloat(match[2]),
                        lng: parseFloat(match[1]),
                        isValid: true
                    };
                }
                
                return { isValid: false };
            }
            
            function isValidCoordinateRange(lat, lng) {
                // Batasan koordinat untuk area Surabaya yang wajar
                return (lat >= -8.0 && lat <= -6.5 && lng >= 112.0 && lng <= 113.5);
            }
            
            // ================= FUNGSI PENCARIAN UTAMA =================
            function performSearch(searchTerm) {
                if (!searchTerm || searchTerm.trim().length === 0) {
                    return;
                }
                
                const searchLower = searchTerm.toLowerCase().trim();
                
                // Cek apakah input adalah koordinat
                const coords = parseCoordinates(searchTerm);
                if (coords.isValid) {
                    searchByCoordinates(coords.lat, coords.lng);
                    return;
                }
                
                // Cari dalam data rumah ibadah
                let foundFeature = null;
                allFeatures.forEach(item => {
                    if (foundFeature) return;
                    
                    const properties = item.feature.properties;
                    const nama = properties.NAMA ? properties.NAMA.toLowerCase() : '';
                    const alamat = properties.ALAMAT ? properties.ALAMAT.toLowerCase() : '';
                    const jenis = properties.JENIS_TEMP ? properties.JENIS_TEMP.toLowerCase() : '';
                    const kecamatan = properties.KECAMATAN ? properties.KECAMATAN.toLowerCase() : '';
                    const kelurahan = properties.KELURAHAN ? properties.KELURAHAN.toLowerCase() : '';
                    
                    if (nama.includes(searchLower) || 
                        alamat.includes(searchLower) || 
                        jenis.includes(searchLower) ||
                        kecamatan.includes(searchLower) ||
                        kelurahan.includes(searchLower)) {
                        foundFeature = item;
                    }
                });

                if (foundFeature) {
                    const coords = foundFeature.feature.geometry.coordinates;
                    const latlng = [coords[1], coords[0]];
                    map.setView(latlng, 17);
                    
                    if (currentSearchMarker) {
                        map.removeLayer(currentSearchMarker);
                        currentSearchMarker = null;
                    }
                    
                    setTimeout(() => {
                        foundFeature.layer.openPopup();
                    }, 500);
                    
                    console.log('Ditemukan: ' + foundFeature.feature.properties.NAMA);
                } else {
                    searchByAddressGoogle(searchTerm);
                }
            }
            
            function searchByCoordinates(lat, lng) {
                if (!isValidCoordinateRange(lat, lng)) {
                    alert('Koordinat berada di luar area Surabaya. Pastikan koordinat berada dalam rentang:\nLatitude: -8.0 hingga -6.5\nLongitude: 112.0 hingga 113.5');
                    return;
                }
                
                const latlng = [lat, lng];
                
                // Hapus marker pencarian sebelumnya
                if (currentSearchMarker) {
                    map.removeLayer(currentSearchMarker);
                }
                
                // Buat marker hasil pencarian koordinat (tanpa bayangan)
                currentSearchMarker = L.marker(latlng, {
                    icon: L.icon({
                        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-green.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34]
                        // shadowUrl dihapus untuk menghilangkan bayangan
                        // shadowSize dihapus untuk menghilangkan bayangan
                    })
                }).addTo(map);
                
                currentSearchMarker.bindPopup(`<strong>Koordinat yang Dicari</strong><br>Latitude: ${lat}<br>Longitude: ${lng}<br><small>Koordinat: ${lat}, ${lng}</small>`).openPopup();
                map.setView(latlng, 16);
                
                console.log(`Lokasi ditemukan dengan koordinat: ${lat}, ${lng}`);
            }

            function searchByAddressGoogle(address) {
                if (typeof google !== 'undefined' && google.maps && google.maps.Geocoder) {
                    const geocoder = new google.maps.Geocoder();
                    const searchAddress = address + ', Surabaya, East Java, Indonesia';
                    
                    geocoder.geocode({'address': searchAddress}, (results, status) => {
                        if (status === 'OK' && results.length > 0) {
                            const lat = results[0].geometry.location.lat();
                            const lng = results[0].geometry.location.lng();
                            const latlng = [lat, lng];

                            if (currentSearchMarker) {
                                map.removeLayer(currentSearchMarker);
                            }

                            // Marker tanpa bayangan
                            currentSearchMarker = L.marker(latlng, {
                                icon: L.icon({
                                    iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-green.png',
                                    iconSize: [25, 41],
                                    iconAnchor: [12, 41],
                                    popupAnchor: [1, -34]
                                    // shadowUrl dihapus untuk menghilangkan bayangan
                                })
                            }).addTo(map);
                            
                            currentSearchMarker.bindPopup('<strong>Hasil Pencarian</strong><br>' + results[0].formatted_address).openPopup();
                            map.setView(latlng, 16);
                            
                            console.log('Lokasi ditemukan dengan Google Geocoding');
                        } else {
                            alert('Lokasi "' + address + '" tidak ditemukan.');
                            console.log('Geocoding gagal: ' + status);
                        }
                    });
                } else {
                    alert('Layanan pencarian tidak tersedia. Pastikan Google Maps API sudah dimuat.');
                    console.error('Google Maps API tidak tersedia atau Geocoder tidak dapat diakses.');
                }
            }

            // ================= FUNGSI SUGGESTION =================
            function showSearchSuggestions(searchTerm) {
                const resultsContainer = document.getElementById('searchResults');
                const searchLower = searchTerm.toLowerCase().trim();
                const suggestions = [];
                
                if (searchTerm.length < 2) {
                    hideSearchResults();
                    return;
                }
                
                // Cek apakah input koordinat
                const coords = parseCoordinates(searchTerm);
                if (coords.isValid) {
                    const isValidRange = isValidCoordinateRange(coords.lat, coords.lng);
                    const statusText = isValidRange ? 'â Valid' : 'â  Di luar area Surabaya';
                    const statusColor = isValidRange ? '#28a745' : '#dc3545';
                    
                    resultsContainer.innerHTML = `
                        <div class="search-result-item" onclick="performSearch('${searchTerm}')">
                            <strong>ð Koordinat: ${coords.lat}, ${coords.lng}</strong><br>
                            <small style="color: ${statusColor};">${statusText}</small>
                        </div>
                    `;
                    resultsContainer.style.display = 'block';
                    return;
                }
                
                // Cari suggestion dari data rumah ibadah
                allFeatures.forEach(item => {
                    if (suggestions.length >= 8) return;
                    
                    const properties = item.feature.properties;
                    const nama = properties.NAMA || '';
                    const jenis = properties.JENIS_TEMP || '';
                    const alamat = properties.ALAMAT || '';
                    const kecamatan = properties.KECAMATAN || '';
                    
                    if (nama.toLowerCase().includes(searchLower) || 
                        jenis.toLowerCase().includes(searchLower) ||
                        alamat.toLowerCase().includes(searchLower) ||
                        kecamatan.toLowerCase().includes(searchLower)) {
                        suggestions.push({
                            displayText: nama + ' (' + jenis + ')',
                            name: nama,
                            jenis: jenis,
                            kecamatan: kecamatan
                        });
                    }
                });
                
                if (suggestions.length > 0) {
                    let html = '';
                    suggestions.forEach(suggestion => {
                        html += `<div class="search-result-item" onclick="selectSuggestion('${suggestion.name.replace(/'/g, "\\'")}')">
                                    <strong>${suggestion.displayText}</strong><br>
                                    <small style="color: #666;">${suggestion.kecamatan}</small>
                                </div>`;
                    });
                    resultsContainer.innerHTML = html;
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.innerHTML = '<div class="search-result-item">Tidak ada hasil ditemukan.</div>';
                    resultsContainer.style.display = 'block';
                }
            }

            function selectSuggestion(name) {
                document.getElementById('search-input').value = name;
                performSearch(name);
                hideSearchResults();
            }

            function hideSearchResults() {
                document.getElementById('searchResults').style.display = 'none';
            }

            // ================= EVENT LISTENERS =================
            function initializeSearchEvents() {
                const searchInput = document.getElementById('search-input');

                searchInput.addEventListener('input', function(e) {
                    showSearchSuggestions(e.target.value);
                });
                
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        performSearch(e.target.value);
                        hideSearchResults();
                    } else if (e.key === 'Escape') {
                        hideSearchResults();
                    }
                });

                // Tutup hasil pencarian saat klik di luar
                document.addEventListener('click', function(e) {
                    const searchCard = document.getElementById('search-card');
                    if (!searchCard.contains(e.target)) {
                        hideSearchResults();
                    }
                });
            }

            // ================= DRAG AND DROP SEARCH CARD =================
            function initializeDragDrop() {
                const searchCard = document.getElementById('search-card');
                const handle = searchCard.querySelector('.card-handle');
                let isDragging = false;
                let startX, startY, startLeft, startTop;
                
                handle.addEventListener('mousedown', function(e) {
                    isDragging = true;
                    startX = e.clientX;
                    startY = e.clientY;
                    const rect = searchCard.getBoundingClientRect();
                    startLeft = rect.left;
                    startTop = rect.top;
                    searchCard.style.cursor = 'grabbing';
                    e.preventDefault();
                });
                
                document.addEventListener('mousemove', function(e) {
                    if (!isDragging) return;
                    e.preventDefault();
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    searchCard.style.left = (startLeft + dx) + 'px';
                    searchCard.style.top = (startTop + dy) + 'px';
                    searchCard.style.transform = 'none';
                });
                
                document.addEventListener('mouseup', function() {
                    if (isDragging) {
                        isDragging = false;
                        searchCard.style.cursor = 'grab';
                    }
                });
            }

            // ================= GOOGLE PLACES AUTOCOMPLETE =================
            function initializeGooglePlaces() {
                const searchInput = document.getElementById('search-input');
                
                if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                    try {
                        const autocomplete = new google.maps.places.Autocomplete(searchInput, {
                            componentRestrictions: {country: 'ID'},
                            bounds: new google.maps.LatLngBounds(
                                new google.maps.LatLng(-7.3, 112.6),
                                new google.maps.LatLng(-7.2, 112.9)
                            ),
                            strictBounds: true,
                            types: ['establishment']
                        });
                        
                        autocomplete.addListener('place_changed', function() {
                            const place = autocomplete.getPlace();
                            if (place.geometry) {
                                hideSearchResults();
                                const lat = place.geometry.location.lat();
                                const lng = place.geometry.location.lng();
                                
                                if (currentSearchMarker) {
                                    map.removeLayer(currentSearchMarker);
                                }
                                
                                // Marker tanpa bayangan
                                currentSearchMarker = L.marker([lat, lng], {
                                    icon: L.icon({
                                        iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-green.png',
                                        iconSize: [25, 41],
                                        iconAnchor: [12, 41],
                                        popupAnchor: [1, -34]
                                        // shadowUrl dihapus untuk menghilangkan bayangan
                                    })
                                }).addTo(map);
                                
                                currentSearchMarker.bindPopup('<strong>' + place.name + '</strong><br>' + place.formatted_address).openPopup();
                                map.setView([lat, lng], 16);
                            }
                        });
                    } catch(error) {
                        console.warn('Google Places Autocomplete tidak dapat diinisialisasi:', error);
                    }
                }
            }

            // ================= INISIALISASI UTAMA =================
            function initialize() {
                initializeMap();
                initializeLayers();
                initializeControls();
                initializeSearchEvents();
                initializeDragDrop();
                initializeGooglePlaces();
                
                // Fungsi global untuk onclick events
                window.selectSuggestion = selectSuggestion;
                window.performSearch = performSearch;
                
                // Log untuk debugging
                console.log('Peta rumah ibadah Surabaya berhasil dimuat');
                console.log('Total rumah ibadah:', allFeatures.length);
                console.log('Fitur pencarian koordinat tersedia');
                console.log('Format koordinat yang didukung:');
                console.log('  - lat,lng: -7.2575,112.7521');
                console.log('  - lat: -7.2575, lng: 112.7521');
                console.log('  - lng: 112.7521, lat: -7.2575');
            }

            // Mulai aplikasi ketika halaman selesai dimuat
            document.addEventListener('DOMContentLoaded', initialize);
        </script>
    </body>
</html>